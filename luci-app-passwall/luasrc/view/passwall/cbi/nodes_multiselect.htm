<%+cbi/valueheader%>
<%
--	Template Developers:
--		- lwb1978
--	Copyright: copyright(c)2025–2027
--	Description: Passwall(2) UI template

local cbid = "cbid." .. self.config .. "." .. section .. "." .. self.option

-- 读取 MultiValue
local values = {}
for i, key in pairs(self.keylist) do
	values[#values + 1] = {
		key = key,
		label = self.vallist[i] or key,
		group = self.group and self.group[i] or nil
	}
end

-- 获取选中值
local selected = {}
local cval = self:cfgvalue(section)
if type(cval) == "table" then
	for _, v in pairs(cval) do
		selected[v] = true
	end
elseif type(cval) == "string" then
	for v in cval:gmatch("%S+") do
		selected[v] = true
	end
end

-- 按原顺序分组
local groups = {}
local group_order = {}
for _, item in ipairs(values) do
	local g = item.group
	if not g or g == "" then 
		g = translate("default") 
	end
	if not groups[g] then 
		groups[g] = {}
		table.insert(group_order, g)
	end
	table.insert(groups[g], item)
end
%>

<div id="<%=cbid%>" class="cbi-input-select" style="display:inline-block;">
	<!-- 搜索 -->
	<input type="text" id="<%=cbid%>.search" class="mv_search_input cbi-input-text" placeholder="<%:Search nodes...%>" />
	<!-- 主容器 -->
	<div class="mv_list_container">
		<ul class="cbi-multi mv_node_list" id="<%=cbid%>.node_list">
			<% for _, gname in ipairs(group_order) do %>
			<% 	local items = groups[gname] %>
			<li class="group-block" data-group="<%=gname%>">
				<!-- 组标题 -->
				<div class="group-title">
					<span id="arrow-<%=self.option%>-<%=gname%>" class="mv-arrow-down-small"></span>
					<b style="margin-left:8px;"><%=gname%></b>
					<span id="group-count-<%=self.option%>-<%=gname%>" style="margin-left:8px;color:#007bff;">
						(0/<%=#items%>)
					</span>
				</div>
				<!-- 组内容 -->
				<ul id="group-<%=self.option%>-<%=gname%>" class="group-items">
				<% for _, item in ipairs(items) do %>
					<li class="node-item" data-node-name="<%=pcdata(item.label):lower()%>" title="<%=pcdata(item.label)%>">
						<div class="mv-node-row">
							<input type="checkbox" class="cbi-input-checkbox mv-node-checkbox"
								<%= attr("id",   cbid .. "." .. item.key) ..
									attr("name", cbid) ..
									attr("value", item.key) ..
									ifattr(selected[item.key], "checked", "checked")
								%> />
							<label for="<%=cbid .. "." .. item.key%>" class="mv-node-label"><%=pcdata(item.label)%></label>
						</div>
					</li>
				<% end %>
				</ul>
			</li>
			<% end %>
		</ul>
	</div>
	<!-- 控制栏 -->
	<div class="mv-controls">
		<input class="btn cbi-button cbi-button-edit" type="button" onclick="mv_selectAll('<%=cbid%>','<%=self.option%>',true)" value="<%:Select all%>">
		<input class="btn cbi-button cbi-button-edit" type="button" onclick="mv_selectAll('<%=cbid%>','<%=self.option%>',false)" value="<%:DeSelect all%>">
		<span id="count-<%=self.option%>" style="color:#666;"></span>
	</div>
</div>
<%+cbi/valuefooter%>

<%
-- 公共部分(只加载一次)
if not _G.__NODES_MULTIVALUE_CSS_JS__ then
	_G.__NODES_MULTIVALUE_CSS_JS__ = true
%>
<style>
/* 组标题的右箭头 */
.mv-arrow-right {
	width: 0;
	height: 0;
	border-top: 4px solid transparent;
	border-bottom: 4px solid transparent;
	border-left: 5px solid #555;
	display: inline-block;
	vertical-align: middle;
}
/* 组标题的下箭头 */
.mv-arrow-down-small {
	width: 0;
	height: 0;
	border-left: 4px solid transparent;
	border-right: 4px solid transparent;
	border-top: 5px solid #555;
	display: inline-block;
	vertical-align: middle;
}
.mv_search_input {
	width: 100%;
	box-sizing: border-box;
	padding: 6px;
	margin-bottom: 8px;
	border: 1px solid #ccc;
	border-radius: 4px;
	max-height: 36px;
}
.mv_list_container {
	max-height: 300px;
	overflow: auto;
	margin-bottom: 8px;
	white-space: nowrap;
}
.mv_node_list {
	width: 100%;
	box-sizing: border-box;
	padding: 0 !important;
	margin: 0 !important;
}
.mv_node_list li.group-block {
	list-style: none;
	padding: 0;
	margin: 0 0 8px 0;
}
.mv_node_list .group-title {
	cursor: pointer;
	display: flex;
	align-items: center;
	padding: 6px;
	margin-bottom: 4px;
	background: #f0f0f0;
	border-radius: 4px;
	white-space: nowrap;
}
.mv_node_list ul.group-items {
	margin: 0 0 8px 16px;
	padding: 0;
	list-style: none;
}
.mv_node_list ul.group-items li.node-item {
	list-style: none;
	padding: 0;
	margin: 0;
	white-space: nowrap;
	text-align: left;
}
.mv-node-row {
	display: inline-flex;
	align-items: center;
	vertical-align: middle;
}
.mv-node-checkbox {
	margin: 0;
	vertical-align: middle;
	margin-right: 6px;
}
.mv-node-label {
	margin: 0;
	padding: 0;
	vertical-align: middle;
	cursor: pointer;
}
.mv-controls {
	margin-top: 4px;
	display: flex;
	gap: 4px;
	align-items: center;
}
</style>

<script type="text/javascript">
//<![CDATA[
	// 折叠组
	function mv_toggleGroup(opt, nodeList, searchInput, g) {
		const ul = nodeList.querySelector("#group-" + opt + "-" + g);
		const arrow = nodeList.querySelector("#arrow-" + opt + "-" + g);
		if (!ul) return;
		// 判断是否在搜索状态
		const keyword = searchInput.value.trim().toLowerCase();
		const isSearching = keyword.length > 0;
		// 搜索状态下，仅切换当前组，不处理其他组
		if (isSearching){
			ul.style.display = ul.style.display === "none" ? "block" : "none";
			if (arrow) arrow.className = ul.style.display === "none" ? "mv-arrow-right" : "mv-arrow-down-small";
			return;
		}
		// 非搜索模式：先折叠其他组
		nodeList.querySelectorAll(".group-block").forEach(group=>{
			const gname = group.getAttribute("data-group");
			const gul = document.getElementById("group-" + opt + "-" + gname);
			const garrow = document.getElementById("arrow-" + opt + "-" + gname);
			if (gname !== g) {
				if (gul) gul.style.display = "none";
				if (garrow) garrow.className = "mv-arrow-right";
			}
		});
		nodeList.parentNode.scrollTop = 0;
		// 切换当前组
		ul.style.display = ul.style.display === "none" ? "block" : "none";
		if (arrow) arrow.className = ul.style.display === "none" ? "mv-arrow-right" : "mv-arrow-down-small";
	};

	// 计数
	function mv_updateCount(opt, nodeList) {
		// 当前实例下的所有 checkbox
		const cbs = nodeList.querySelectorAll("input[type=checkbox]");
		let checked = 0;
		cbs.forEach(cb => { if(cb.checked) checked++; });
		// 更新总计
		const totalSpan = document.getElementById("count-" + opt);
		if (totalSpan) {
			totalSpan.innerHTML = "<%:Selected:%> <span style='color:red;'>" + checked + " / " + cbs.length + "</span>";
		}
		// 更新每个组计数
		nodeList.querySelectorAll(".group-block").forEach(group => {
			const gname = group.getAttribute("data-group");
			const groupCbs = group.querySelectorAll("li[data-node-name] input[type=checkbox]");
			let groupChecked = 0;
			groupCbs.forEach(cb => { if(cb.checked) groupChecked++; });
			const span = document.getElementById("group-count-" + opt + "-" + gname);
			if(span) span.textContent = "(" + groupChecked + "/" + groupCbs.length + ")";
		});
	}

	// 搜索
	function mv_filterGroups(keyword, opt, nodeList) {
		keyword = (keyword || "").toLowerCase().trim();
		nodeList.querySelectorAll(".group-block").forEach(group => {
			const items = group.querySelectorAll("li[data-node-name]");
			let matchCount = 0;
			items.forEach(li => {
				const name = li.getAttribute("data-node-name");
				if (!keyword || name.indexOf(keyword) !== -1) {
					li.style.display = "";
					matchCount++;
				} else {
					li.style.display = "none";
				}
			});
			// 搜索时自动展开组
			const gname = group.getAttribute("data-group");
			const ul = document.getElementById("group-" + opt + "-" + gname);
			const arrow = document.getElementById("arrow-" + opt + "-" + gname);

			if (matchCount === 0 && keyword !== "") {
				group.style.display = "none";
			} else {
				group.style.display = "";
				if (keyword && ul && arrow) {
					ul.style.display = "";
					arrow.className = "mv-arrow-down-small";
				}
			}
		});
		mv_updateCount(opt, nodeList);
		// 清空搜索后恢复全部折叠
		if (!keyword) {
			mv_collapseAllGroups(opt, nodeList);
		}
	}

	// 全选 / 全不选
	function mv_selectAll(cbid, opt, flag) {
		const nodeList = document.getElementById(cbid + ".node_list");
		const cbs = nodeList.querySelectorAll("input[type=checkbox]");
		cbs.forEach(cb=>{
			if (cb.offsetParent !== null) cb.checked = flag;
		});
		mv_updateCount(opt, nodeList);
	};

	// 折叠所有组
	function mv_collapseAllGroups(opt, nodeList) {
		nodeList.querySelectorAll(".group-block").forEach(group => {
			const gname = group.getAttribute("data-group");
			const ul = document.getElementById("group-" + opt + "-" + gname);
			const arrow = document.getElementById("arrow-" + opt + "-" + gname);
			if (ul) ul.style.display = "none";
			if (arrow) arrow.className = "mv-arrow-right";
		});
	}
//]]>
</script>
<% end %>

<script type="text/javascript">
//<![CDATA[
(function(){
	const cbid = "<%=cbid%>";
	const opt = "<%=self.option%>";
	const searchInput = document.getElementById(cbid + ".search");
	const nodeList = document.getElementById(cbid + ".node_list");

	nodeList.querySelectorAll(".group-title").forEach(title => {
		title.addEventListener("click", function() {
			const g = this.closest(".group-block")?.getAttribute("data-group");
			if (g) mv_toggleGroup(opt, nodeList, searchInput, g);
		});
	});

	searchInput.addEventListener("input", function() {
		mv_filterGroups(this.value, opt, nodeList);
	})

	// checkbox 改变时更新计数
	nodeList.addEventListener("change", () => {
		mv_updateCount(opt, nodeList);
	});

	// 初始化折叠所有组和计数
	mv_collapseAllGroups(opt, nodeList)
	mv_updateCount(opt, nodeList);

})();
//]]>
</script>
